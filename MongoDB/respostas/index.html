<!doctype html>
<html lang="en">

<head>
        <title>Respostas - Meus Estudos</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        
        
        

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
            <link rel="stylesheet" href="../../assets/css/darcula-highlight.min.css">

        <link rel="stylesheet" href="../../assets/css/bootstrap.min.css">
        <link rel="stylesheet" href="../../assets/css/dracula-ui.min.css">
        <link rel="stylesheet" href="../../assets/css/mkdocs.min.css">

        
            <link  rel="icon" type="image/x-icon" href="../../assets/img/favicon.ico">
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
                <script>hljs.initHighlightingOnLoad();</script>

</head>

<body class="drac-bg-black-secondary drac-text-grey-ternary drac-text drac-scrollbar-purple">

    <main class="d-flex">

        <!-- block sidebar -->
            <nav id="sidebar" class="sidebar drac-bg-black">
    <div class="custom-menu">
        <button type="button" id="sidebarCollapse" class="btn btn-primary">
            <i class="fa fa-bars"></i>
            <span class="sr-only">Menu</span>
        </button>
    </div>

    <div class="p-4">
        

        <div class="drac-text-center">
            
                <span class="drac-text drac-line-height drac-text-white">Meus Estudos</span>
            
        </div>

        <div class="drac-box flex-column">
            <ul class="dot-ul">
                <li><div class="dot-li drac-bg-cyan"></div></li>
                <li><div class="dot-li drac-bg-green"></div></li>
                <li><div class="dot-li drac-bg-orange"></div></li>
                <li><div class="dot-li drac-bg-pink"></div></li>
                <li><div class="dot-li drac-bg-purple"></div></li>
                <li><div class="dot-li drac-bg-red"></div></li>
                <li><div class="dot-li drac-bg-yellow"></div></li>
            </ul>
        </div>

        <hr class="drac-divider" />

        <!-- block menu -->
        <ul class="mb-5 drac-list drac-list-none">
            
            <li class="drac-box">
                <a href="../.."
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Início
                </a>
            </li>
            <li class="drac-box">
                <a href="../.."
                    class="
                    drac-anchor btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
                    data-bs-toggle="collapse" data-bs-target="#requisitos-collapse" aria-expanded="false">
                    Requisitos
                </a>
                <div class="collapse" id="requisitos-collapse">
                    <ul class="mb-5 drac-list drac-list-none">
                            
    <li class="drac-box-ternary">
        <a href="../../Requisitos/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Visão Geral
        </a>
    </li>
                    </ul>
                </div>
            </li>
            <li class="drac-box">
                <a href="../.."
                    class="
                    drac-anchor btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
                    data-bs-toggle="collapse" data-bs-target="#lógica-collapse" aria-expanded="false">
                    Lógica
                </a>
                <div class="collapse" id="lógica-collapse">
                    <ul class="mb-5 drac-list drac-list-none">
                            
    <li class="drac-box-ternary">
        <a href="../../Logica/apostila/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Lógica de Programação
        </a>
    </li>
                    </ul>
                </div>
            </li>
            <li class="drac-box">
                <a href="../.."
                    class="
                    drac-anchor btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
                    data-bs-toggle="collapse" data-bs-target="#web-collapse" aria-expanded="false">
                    Web
                </a>
                <div class="collapse" id="web-collapse">
                    <ul class="mb-5 drac-list drac-list-none">
                            
    <li class="drac-box-ternary">
        <a href="../../Web/Armazenamento/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Armazenamento Web
        </a>
    </li>
                    </ul>
                </div>
            </li>
            <li class="drac-box">
                <a href="../.."
                    class="
                    drac-anchor btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
                    data-bs-toggle="collapse" data-bs-target="#typescript-collapse" aria-expanded="false">
                    TypeScript
                </a>
                <div class="collapse" id="typescript-collapse">
                    <ul class="mb-5 drac-list drac-list-none">
                            
    <li class="drac-box-ternary">
        <a href="../../Ts/estrutura-plano/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Visão Geral
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../../Ts/Semana1/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Semana 1
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../../Ts/Semana2/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Semana 2
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../../Ts/Semana3/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Semana 3
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../../Ts/Semana4/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Semana 4
        </a>
    </li>
                    </ul>
                </div>
            </li>
            <li class="drac-box">
                <a href="../.."
                    class=" active 
                    drac-anchor btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
                    data-bs-toggle="collapse" data-bs-target="#mongo-collapse" aria-expanded="false">
                    Mongo
                </a>
                <div class="collapse" id="mongo-collapse">
                    <ul class="mb-5 drac-list drac-list-none">
                            
    <li class="drac-box-ternary">
        <a href="../apostila/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Apostila
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="./"
            class=" active 
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Respostas
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../tarefas/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Tarefas
        </a>
    </li>
                    </ul>
                </div>
            </li>
        </ul>
        <!-- endblock -->
    </div>
</nav>
        <!-- endblock -->

        <nav class="divider drac-bg-purple-cyan"></nav>

        <div class="content">
            <!-- block header -->
                <header>
    <nav class="navbar navbar-expand-xl drac-bg-purple">
        <div class="container-fluid">
            
            <button class="navbar-toggler w-100 text-center" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsMenu"
                aria-controls="navbarsMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse flex-column ml-auto" id="navbarsMenu">
                <ul class="navbar-nav text-md-center">

                    <!-- block preview -->
                    <li class="nav-item">
                            
        <div class="container">
            <div class="row row-preview">
                <div class="col">
                    <a href="../apostila/"
                        class="btn-preview drac-btn drac-btn-outline drac-text-white drac-text-cyan-green--hover">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </div>
                <div class="col">
                    <a href="../tarefas/"
                        class="btn-preview drac-btn drac-btn-outline drac-text-white drac-text-cyan-green--hover" style="padding-left: 3%;">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
                    </li>
                    <!--  endblock -->

                    <!-- block search -->
                    <li class="nav-item"><div role="search" class="search-box">
	<form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
		<input type="text" name="q" class="drac-input drac-input-search drac-input-white drac-text-white drac-bg-black-secondary"
		placeholder="Search docs" title="Type search term here" />
	</form>
</div>
                    </li>
                    <!--  endblock -->

                    <!-- block source -->
                    <li class="nav-item">
                        
                    </li>
                    <!--  endblock -->

                </ul>
            </div>

        </div>
    </nav>
</header>
            <!-- endblock -->

            <!-- block content -->
                <section class="p-md-5 section-content">
    <article>
        <p><h1 id="projeto-mongodb-e-commerce">Projeto MongoDB E-commerce</h1>
<p>Este documento contém todas as respostas e consultas para as tarefas do projeto de banco de dados e-commerce utilizando MongoDB.</p>
<p><a href="https://www.mongodb.com/pt-br/docs/manual/introduction/">Documentação Oficial</a></p>
<p><a href="https://www.youtube.com/playlist?list=PL4cUxeGkcC9h77dJ-QJlwGlZlTd4ecZOA">Curso Básico de Mongo - Legendado </a></p>
<p><a href="https://www.youtube.com/watch?v=04gyv76r_Ts&amp;t=1873s&amp;ab_channel=HashtagPrograma%C3%A7%C3%A3o">Diferenças entre NoSQL e SQL</a></p>
<hr />
<h2 id="introducao">Introdução</h2>
<p>Esta apostila contém uma série de tarefas práticas para consolidar os conhecimentos adquiridos durante o Workshop de MongoDB. As tarefas estão organizadas em ordem crescente de dificuldade, acompanhando a evolução do curso e culminando no desenvolvimento do projeto final de e-commerce.</p>
<hr />
<h2 id="tarefa-1-configuracao-do-banco-de-dados">Tarefa 1: Configuração do Banco de Dados</h2>
<h3 id="1-criacao-do-banco-de-dados">1. Criação do banco de dados</h3>
<pre><code class="language-javascript">// Conectar ao MongoDB
mongo

// Criar e usar o banco de dados ecommerce_db
use ecommerce_db
</code></pre>
<h3 id="2-verificacao-da-conexao">2. Verificação da conexão</h3>
<pre><code class="language-javascript">// Usando mongosh
test&gt; db.getMongo().getDBNames()

// Verifique se &quot;ecommerce_db&quot; está na lista

// Ou simplesmente
test&gt; show dbs
</code></pre>
<hr />
<h2 id="tarefa-2-criacao-da-estrutura-de-dados">Tarefa 2: Criação da Estrutura de Dados</h2>
<h3 id="1-criacao-das-colecoes">1. Criação das coleções</h3>
<pre><code class="language-javascript">use ecommerce_db

// Criar coleções
db.createCollection(&quot;produtos&quot;)
db.createCollection(&quot;categorias&quot;)
db.createCollection(&quot;clientes&quot;)
db.createCollection(&quot;pedidos&quot;)
db.createCollection(&quot;avaliacoes&quot;)

// Verificar coleções criadas
show collections
</code></pre>
<h3 id="2-insercao-de-categorias">2. Inserção de categorias</h3>
<pre><code class="language-javascript">db.categorias.insertMany([
  { nome: &quot;Eletrônicos&quot;, descricao: &quot;Dispositivos e gadgets eletrônicos&quot; },
  { nome: &quot;Móveis&quot;, descricao: &quot;Móveis para casa e escritório&quot; },
  { nome: &quot;Roupas&quot;, descricao: &quot;Vestuário e acessórios&quot; },
  { nome: &quot;Livros&quot;, descricao: &quot;Livros físicos e digitais&quot; },
  { nome: &quot;Esportes&quot;, descricao: &quot;Artigos esportivos e equipamentos&quot; }
])
</code></pre>
<hr />
<h2 id="tarefa-3-operacoes-crud-basicas">Tarefa 3: Operações CRUD Básicas</h2>
<h3 id="1-insercao-de-produtos">1. Inserção de produtos</h3>
<pre><code class="language-javascript">db.produtos.insertMany([
  {
    nome: &quot;Smartphone Galaxy X20&quot;,
    descricao: &quot;Smartphone com 128GB, 8GB RAM e câmera de 64MP&quot;,
    preco: 2499.99,
    estoque: 50,
    categoria: &quot;Eletrônicos&quot;,
    tags: [&quot;smartphone&quot;, &quot;samsung&quot;, &quot;android&quot;]
  },
  {
    nome: &quot;Notebook UltraSlim&quot;,
    descricao: &quot;Notebook leve com processador i7, 16GB RAM e SSD 512GB&quot;,
    preco: 4299.99,
    estoque: 25,
    categoria: &quot;Eletrônicos&quot;,
    tags: [&quot;notebook&quot;, &quot;computador&quot;, &quot;trabalho&quot;]
  },
  {
    nome: &quot;Smart TV 55'&quot;,
    descricao: &quot;TV LED 4K com recursos smart e HDR&quot;,
    preco: 3199.99,
    estoque: 30,
    categoria: &quot;Eletrônicos&quot;,
    tags: [&quot;tv&quot;, &quot;4k&quot;, &quot;smarttv&quot;]
  },
  {
    nome: &quot;Sofá Retrátil&quot;,
    descricao: &quot;Sofá de 3 lugares com assento retrátil e tecido suede&quot;,
    preco: 1899.99,
    estoque: 10,
    categoria: &quot;Móveis&quot;,
    tags: [&quot;sofa&quot;, &quot;sala&quot;, &quot;conforto&quot;]
  },
  {
    nome: &quot;Mesa de Jantar&quot;,
    descricao: &quot;Mesa de jantar 6 lugares em madeira maciça&quot;,
    preco: 1299.99,
    estoque: 15,
    categoria: &quot;Móveis&quot;,
    tags: [&quot;mesa&quot;, &quot;jantar&quot;, &quot;madeira&quot;]
  },
  {
    nome: &quot;Guarda-roupa Casal&quot;,
    descricao: &quot;Guarda-roupa 6 portas com espelho e gavetas&quot;,
    preco: 1599.99,
    estoque: 12,
    categoria: &quot;Móveis&quot;,
    tags: [&quot;guarda-roupa&quot;, &quot;quarto&quot;, &quot;organizacao&quot;]
  },
  {
    nome: &quot;Camiseta Básica&quot;,
    descricao: &quot;Camiseta 100% algodão em diversas cores&quot;,
    preco: 49.99,
    estoque: 200,
    categoria: &quot;Roupas&quot;,
    tags: [&quot;camiseta&quot;, &quot;casual&quot;, &quot;algodao&quot;]
  },
  {
    nome: &quot;Calça Jeans Slim&quot;,
    descricao: &quot;Calça jeans com corte moderno e confortável&quot;,
    preco: 129.99,
    estoque: 150,
    categoria: &quot;Roupas&quot;,
    tags: [&quot;calca&quot;, &quot;jeans&quot;, &quot;casual&quot;]
  },
  {
    nome: &quot;Tênis Running&quot;,
    descricao: &quot;Tênis para corrida com amortecimento e suporte&quot;,
    preco: 299.99,
    estoque: 80,
    categoria: &quot;Esportes&quot;,
    tags: [&quot;tenis&quot;, &quot;corrida&quot;, &quot;esporte&quot;]
  },
  {
    nome: &quot;Livro: O Senhor dos Anéis&quot;,
    descricao: &quot;Trilogia completa em capa dura&quot;,
    preco: 149.99,
    estoque: 30,
    categoria: &quot;Livros&quot;,
    tags: [&quot;livro&quot;, &quot;fantasia&quot;, &quot;tolkien&quot;]
  },
  {
    nome: &quot;Bola de Futebol Oficial&quot;,
    descricao: &quot;Bola de futebol profissional tamanho 5&quot;,
    preco: 89.99,
    estoque: 60,
    categoria: &quot;Esportes&quot;,
    tags: [&quot;futebol&quot;, &quot;bola&quot;, &quot;esporte&quot;]
  },
  {
    nome: &quot;Kit Halteres&quot;,
    descricao: &quot;Kit com 2 halteres de 5kg cada&quot;,
    preco: 159.99,
    estoque: 40,
    categoria: &quot;Esportes&quot;,
    tags: [&quot;musculacao&quot;, &quot;fitness&quot;, &quot;treino&quot;]
  },
  {
    nome: &quot;Fone de Ouvido Bluetooth&quot;,
    descricao: &quot;Fone sem fio com cancelamento de ruído&quot;,
    preco: 349.99,
    estoque: 45,
    categoria: &quot;Eletrônicos&quot;,
    tags: [&quot;fone&quot;, &quot;audio&quot;, &quot;bluetooth&quot;]
  },
  {
    nome: &quot;Vestido de Festa&quot;,
    descricao: &quot;Vestido longo com detalhes em renda&quot;,
    preco: 259.99,
    estoque: 0,
    categoria: &quot;Roupas&quot;,
    tags: [&quot;vestido&quot;, &quot;festa&quot;, &quot;elegante&quot;]
  },
  {
    nome: &quot;Livro: Programação em MongoDB&quot;,
    descricao: &quot;Guia completo de MongoDB para desenvolvedores&quot;,
    preco: 79.99,
    estoque: 20,
    categoria: &quot;Livros&quot;,
    tags: [&quot;livro&quot;, &quot;programacao&quot;, &quot;tecnologia&quot;]
  }
])
</code></pre>
<h3 id="2-insercao-de-clientes">2. Inserção de clientes</h3>
<pre><code class="language-javascript">db.clientes.insertMany([
  {
    nome: &quot;Ana Silva&quot;,
    email: &quot;ana.silva@email.com&quot;,
    telefone: &quot;(11) 98765-4321&quot;,
    endereco: {
      rua: &quot;Rua das Flores&quot;,
      numero: 123,
      bairro: &quot;Jardim Primavera&quot;,
      cidade: &quot;São Paulo&quot;,
      estado: &quot;SP&quot;,
      cep: &quot;01234-567&quot;
    }
  },
  {
    nome: &quot;Carlos Oliveira&quot;,
    email: &quot;carlos.oliveira@email.com&quot;,
    telefone: &quot;(21) 99876-5432&quot;,
    endereco: {
      rua: &quot;Avenida Central&quot;,
      numero: 456,
      bairro: &quot;Centro&quot;,
      cidade: &quot;Rio de Janeiro&quot;,
      estado: &quot;RJ&quot;,
      cep: &quot;20000-123&quot;
    }
  },
  {
    nome: &quot;Mariana Costa&quot;,
    email: &quot;mariana.costa@email.com&quot;,
    telefone: &quot;(31) 97654-3210&quot;,
    endereco: {
      rua: &quot;Rua dos Ipês&quot;,
      numero: 789,
      bairro: &quot;Savassi&quot;,
      cidade: &quot;Belo Horizonte&quot;,
      estado: &quot;MG&quot;,
      cep: &quot;30000-456&quot;
    }
  },
  {
    nome: &quot;Pedro Santos&quot;,
    email: &quot;pedro.santos@email.com&quot;,
    telefone: &quot;(41) 98765-1234&quot;,
    endereco: {
      rua: &quot;Alameda dos Pinheiros&quot;,
      numero: 321,
      bairro: &quot;Batel&quot;,
      cidade: &quot;Curitiba&quot;,
      estado: &quot;PR&quot;,
      cep: &quot;80000-789&quot;
    }
  },
  {
    nome: &quot;Juliana Mendes&quot;,
    email: &quot;juliana.mendes@email.com&quot;,
    telefone: &quot;(51) 99876-2345&quot;,
    endereco: {
      rua: &quot;Rua da Praia&quot;,
      numero: 654,
      bairro: &quot;Moinhos de Vento&quot;,
      cidade: &quot;Porto Alegre&quot;,
      estado: &quot;RS&quot;,
      cep: &quot;90000-123&quot;
    }
  },
  {
    nome: &quot;Rafael Lima&quot;,
    email: &quot;rafael.lima@email.com&quot;,
    telefone: &quot;(81) 98765-5678&quot;,
    endereco: {
      rua: &quot;Avenida Boa Viagem&quot;,
      numero: 987,
      bairro: &quot;Boa Viagem&quot;,
      cidade: &quot;Recife&quot;,
      estado: &quot;PE&quot;,
      cep: &quot;50000-456&quot;
    }
  },
  {
    nome: &quot;Fernanda Moreira&quot;,
    email: &quot;fernanda.moreira@email.com&quot;,
    telefone: &quot;(71) 99876-7890&quot;,
    endereco: {
      rua: &quot;Avenida Oceânica&quot;,
      numero: 159,
      bairro: &quot;Barra&quot;,
      cidade: &quot;Salvador&quot;,
      estado: &quot;BA&quot;,
      cep: &quot;40000-789&quot;
    }
  },
  {
    nome: &quot;Lucas Almeida&quot;,
    email: &quot;lucas.almeida@email.com&quot;,
    telefone: &quot;(61) 98765-8901&quot;,
    endereco: {
      rua: &quot;SQN 305&quot;,
      numero: 405,
      apt: &quot;202&quot;,
      bairro: &quot;Asa Norte&quot;,
      cidade: &quot;Brasília&quot;,
      estado: &quot;DF&quot;,
      cep: &quot;70000-123&quot;
    }
  }
])
</code></pre>
<h3 id="3-atualizacao-de-estoque">3. Atualização de estoque</h3>
<pre><code class="language-javascript">// Atualizar estoque do Smartphone
db.produtos.updateOne(
  { nome: &quot;Smartphone Galaxy X20&quot; },
  { $set: { estoque: 45 } }
)

// Atualizar estoque do Notebook
db.produtos.updateOne(
  { nome: &quot;Notebook UltraSlim&quot; },
  { $set: { estoque: 20 } }
)

// Atualizar estoque da Camiseta
db.produtos.updateOne(
  { nome: &quot;Camiseta Básica&quot; },
  { $set: { estoque: 180 } }
)
</code></pre>
<h3 id="4-remocao-de-produto-com-estoque-zerado">4. Remoção de produto com estoque zerado</h3>
<pre><code class="language-javascript">db.produtos.deleteOne({ estoque: 0 })
</code></pre>
<h3 id="5-listagem-de-produtos-em-ordem-alfabetica">5. Listagem de produtos em ordem alfabética</h3>
<pre><code class="language-javascript">db.produtos.find().sort({ nome: 1 })
</code></pre>
<hr />
<h2 id="tarefa-4-consultas-avancadas">Tarefa 4: Consultas Avançadas</h2>
<h3 id="1-busca-por-faixa-de-preco">1. Busca por faixa de preço</h3>
<pre><code class="language-javascript">// Produtos entre R$100 e R$500
db.produtos.find({
  preco: { $gte: 100, $lte: 500 }
})
</code></pre>
<h3 id="2-busca-por-palavra-no-nome-usando-regex">2. Busca por palavra no nome usando regex</h3>
<pre><code class="language-javascript">// Produtos que contenham &quot;Smart&quot; no nome
db.produtos.find({
  nome: { $regex: &quot;Smart&quot;, $options: &quot;i&quot; }
})
</code></pre>
<h3 id="3-busca-por-categoria-e-ordenacao-por-preco">3. Busca por categoria e ordenação por preço</h3>
<pre><code class="language-javascript">// Produtos da categoria Eletrônicos ordenados por preço decrescente
db.produtos.find({ categoria: &quot;Eletrônicos&quot; }).sort({ preco: -1 })
</code></pre>
<h3 id="4-busca-de-clientes-por-cidade">4. Busca de clientes por cidade</h3>
<pre><code class="language-javascript">// Clientes que moram em São Paulo
db.clientes.find({ &quot;endereco.cidade&quot;: &quot;São Paulo&quot; })
</code></pre>
<h3 id="5-busca-por-tags-especificas">5. Busca por tags específicas</h3>
<pre><code class="language-javascript">// Produtos com a tag &quot;esporte&quot;
db.produtos.find({ tags: &quot;esporte&quot; })
</code></pre>
<h3 id="6-consulta-dos-5-produtos-mais-caros">6. Consulta dos 5 produtos mais caros</h3>
<pre><code class="language-javascript">db.produtos.find().sort({ preco: -1 }).limit(5)
</code></pre>
<hr />
<h2 id="tarefa-5-relacionamentos-e-documentos-complexos">Tarefa 5: Relacionamentos e Documentos Complexos</h2>
<h3 id="1-criacao-de-pedidos">1. Criação de pedidos</h3>
<pre><code class="language-javascript">// Função auxiliar para atualizar estoque
function atualizarEstoque(produtoId, quantidade) {
  db.produtos.updateOne(
    { _id: produtoId },
    { $inc: { estoque: -quantidade } }
  );
}

// Criar 10 pedidos

// Pedido 1
let pedido1 = {
  cliente: db.clientes.findOne({ nome: &quot;Ana Silva&quot; })._id,
  data: new Date(&quot;2024-03-01T10:30:00Z&quot;),
  status: &quot;Entregue&quot;,
  itens: [
    {
      produto: db.produtos.findOne({ nome: &quot;Smartphone Galaxy X20&quot; })._id,
      nome: &quot;Smartphone Galaxy X20&quot;,
      preco: 2499.99,
      quantidade: 1
    },
    {
      produto: db.produtos.findOne({ nome: &quot;Fone de Ouvido Bluetooth&quot; })._id,
      nome: &quot;Fone de Ouvido Bluetooth&quot;,
      preco: 349.99,
      quantidade: 1
    }
  ],
  valorTotal: 2849.98
};

db.pedidos.insertOne(pedido1);
atualizarEstoque(pedido1.itens[0].produto, pedido1.itens[0].quantidade);
atualizarEstoque(pedido1.itens[1].produto, pedido1.itens[1].quantidade);

// Pedido 2
let pedido2 = {
  cliente: db.clientes.findOne({ nome: &quot;Carlos Oliveira&quot; })._id,
  data: new Date(&quot;2024-03-05T14:15:00Z&quot;),
  status: &quot;Entregue&quot;,
  itens: [
    {
      produto: db.produtos.findOne({ nome: &quot;Smart TV 55'&quot; })._id,
      nome: &quot;Smart TV 55'&quot;,
      preco: 3199.99,
      quantidade: 1
    }
  ],
  valorTotal: 3199.99
};

db.pedidos.insertOne(pedido2);
atualizarEstoque(pedido2.itens[0].produto, pedido2.itens[0].quantidade);

// Pedido 3
let pedido3 = {
  cliente: db.clientes.findOne({ nome: &quot;Mariana Costa&quot; })._id,
  data: new Date(&quot;2024-03-10T09:45:00Z&quot;),
  status: &quot;Entregue&quot;,
  itens: [
    {
      produto: db.produtos.findOne({ nome: &quot;Livro: O Senhor dos Anéis&quot; })._id,
      nome: &quot;Livro: O Senhor dos Anéis&quot;,
      preco: 149.99,
      quantidade: 1
    },
    {
      produto: db.produtos.findOne({ nome: &quot;Livro: Programação em MongoDB&quot; })._id,
      nome: &quot;Livro: Programação em MongoDB&quot;,
      preco: 79.99,
      quantidade: 1
    }
  ],
  valorTotal: 229.98
};

db.pedidos.insertOne(pedido3);
atualizarEstoque(pedido3.itens[0].produto, pedido3.itens[0].quantidade);
atualizarEstoque(pedido3.itens[1].produto, pedido3.itens[1].quantidade);

// Pedido 4
let pedido4 = {
  cliente: db.clientes.findOne({ nome: &quot;Pedro Santos&quot; })._id,
  data: new Date(&quot;2024-03-12T16:20:00Z&quot;),
  status: &quot;Em transporte&quot;,
  itens: [
    {
      produto: db.produtos.findOne({ nome: &quot;Sofá Retrátil&quot; })._id,
      nome: &quot;Sofá Retrátil&quot;,
      preco: 1899.99,
      quantidade: 1
    },
    {
      produto: db.produtos.findOne({ nome: &quot;Mesa de Jantar&quot; })._id,
      nome: &quot;Mesa de Jantar&quot;,
      preco: 1299.99,
      quantidade: 1
    }
  ],
  valorTotal: 3199.98
};

db.pedidos.insertOne(pedido4);
atualizarEstoque(pedido4.itens[0].produto, pedido4.itens[0].quantidade);
atualizarEstoque(pedido4.itens[1].produto, pedido4.itens[1].quantidade);

// Pedido 5
let pedido5 = {
  cliente: db.clientes.findOne({ nome: &quot;Juliana Mendes&quot; })._id,
  data: new Date(&quot;2024-03-15T11:30:00Z&quot;),
  status: &quot;Em processamento&quot;,
  itens: [
    {
      produto: db.produtos.findOne({ nome: &quot;Camiseta Básica&quot; })._id,
      nome: &quot;Camiseta Básica&quot;,
      preco: 49.99,
      quantidade: 3
    },
    {
      produto: db.produtos.findOne({ nome: &quot;Calça Jeans Slim&quot; })._id,
      nome: &quot;Calça Jeans Slim&quot;,
      preco: 129.99,
      quantidade: 2
    }
  ],
  valorTotal: 409.95
};

db.pedidos.insertOne(pedido5);
atualizarEstoque(pedido5.itens[0].produto, pedido5.itens[0].quantidade);
atualizarEstoque(pedido5.itens[1].produto, pedido5.itens[1].quantidade);

// Pedido 6
let pedido6 = {
  cliente: db.clientes.findOne({ nome: &quot;Rafael Lima&quot; })._id,
  data: new Date(&quot;2024-03-18T13:45:00Z&quot;),
  status: &quot;Entregue&quot;,
  itens: [
    {
      produto: db.produtos.findOne({ nome: &quot;Tênis Running&quot; })._id,
      nome: &quot;Tênis Running&quot;,
      preco: 299.99,
      quantidade: 1
    },
    {
      produto: db.produtos.findOne({ nome: &quot;Bola de Futebol Oficial&quot; })._id,
      nome: &quot;Bola de Futebol Oficial&quot;,
      preco: 89.99,
      quantidade: 1
    },
    {
      produto: db.produtos.findOne({ nome: &quot;Kit Halteres&quot; })._id,
      nome: &quot;Kit Halteres&quot;,
      preco: 159.99,
      quantidade: 1
    }
  ],
  valorTotal: 549.97
};

db.pedidos.insertOne(pedido6);
atualizarEstoque(pedido6.itens[0].produto, pedido6.itens[0].quantidade);
atualizarEstoque(pedido6.itens[1].produto, pedido6.itens[1].quantidade);
atualizarEstoque(pedido6.itens[2].produto, pedido6.itens[2].quantidade);

// Pedido 7
let pedido7 = {
  cliente: db.clientes.findOne({ nome: &quot;Fernanda Moreira&quot; })._id,
  data: new Date(&quot;2024-03-20T10:15:00Z&quot;),
  status: &quot;Entregue&quot;,
  itens: [
    {
      produto: db.produtos.findOne({ nome: &quot;Notebook UltraSlim&quot; })._id,
      nome: &quot;Notebook UltraSlim&quot;,
      preco: 4299.99,
      quantidade: 1
    },
    {
      produto: db.produtos.findOne({ nome: &quot;Fone de Ouvido Bluetooth&quot; })._id,
      nome: &quot;Fone de Ouvido Bluetooth&quot;,
      preco: 349.99,
      quantidade: 1
    }
  ],
  valorTotal: 4649.98
};

db.pedidos.insertOne(pedido7);
atualizarEstoque(pedido7.itens[0].produto, pedido7.itens[0].quantidade);
atualizarEstoque(pedido7.itens[1].produto, pedido7.itens[1].quantidade);

// Pedido 8
let pedido8 = {
  cliente: db.clientes.findOne({ nome: &quot;Lucas Almeida&quot; })._id,
  data: new Date(&quot;2024-03-22T15:30:00Z&quot;),
  status: &quot;Em transporte&quot;,
  itens: [
    {
      produto: db.produtos.findOne({ nome: &quot;Guarda-roupa Casal&quot; })._id,
      nome: &quot;Guarda-roupa Casal&quot;,
      preco: 1599.99,
      quantidade: 1
    }
  ],
  valorTotal: 1599.99
};

db.pedidos.insertOne(pedido8);
atualizarEstoque(pedido8.itens[0].produto, pedido8.itens[0].quantidade);

// Pedido 9
let pedido9 = {
  cliente: db.clientes.findOne({ nome: &quot;Ana Silva&quot; })._id,
  data: new Date(&quot;2024-03-25T09:00:00Z&quot;),
  status: &quot;Em processamento&quot;,
  itens: [
    {
      produto: db.produtos.findOne({ nome: &quot;Livro: Programação em MongoDB&quot; })._id,
      nome: &quot;Livro: Programação em MongoDB&quot;,
      preco: 79.99,
      quantidade: 1
    }
  ],
  valorTotal: 79.99
};

db.pedidos.insertOne(pedido9);
atualizarEstoque(pedido9.itens[0].produto, pedido9.itens[0].quantidade);

// Pedido 10
let pedido10 = {
  cliente: db.clientes.findOne({ nome: &quot;Carlos Oliveira&quot; })._id,
  data: new Date(&quot;2024-03-28T14:00:00Z&quot;),
  status: &quot;Aguardando pagamento&quot;,
  itens: [
    {
      produto: db.produtos.findOne({ nome: &quot;Camiseta Básica&quot; })._id,
      nome: &quot;Camiseta Básica&quot;,
      preco: 49.99,
      quantidade: 2
    },
    {
      produto: db.produtos.findOne({ nome: &quot;Calça Jeans Slim&quot; })._id,
      nome: &quot;Calça Jeans Slim&quot;,
      preco: 129.99,
      quantidade: 1
    }
  ],
  valorTotal: 229.97
};

db.pedidos.insertOne(pedido10);
atualizarEstoque(pedido10.itens[0].produto, pedido10.itens[0].quantidade);
atualizarEstoque(pedido10.itens[1].produto, pedido10.itens[1].quantidade);
</code></pre>
<h3 id="2-criacao-de-avaliacoes">2. Criação de avaliações</h3>
<pre><code class="language-javascript">// Avaliações para o pedido 1
db.avaliacoes.insertMany([
  {
    produto: db.produtos.findOne({ nome: &quot;Smartphone Galaxy X20&quot; })._id,
    cliente: db.clientes.findOne({ nome: &quot;Ana Silva&quot; })._id,
    pedido: db.pedidos.findOne({
      cliente: db.clientes.findOne({ nome: &quot;Ana Silva&quot; })._id,
      &quot;itens.nome&quot;: &quot;Smartphone Galaxy X20&quot;
    })._id,
    nota: 5,
    comentario: &quot;Excelente smartphone, câmera incrível e bateria de longa duração.&quot;,
    data: new Date(&quot;2024-03-05T14:30:00Z&quot;)
  },
  {
    produto: db.produtos.findOne({ nome: &quot;Fone de Ouvido Bluetooth&quot; })._id,
    cliente: db.clientes.findOne({ nome: &quot;Ana Silva&quot; })._id,
    pedido: db.pedidos.findOne({
      cliente: db.clientes.findOne({ nome: &quot;Ana Silva&quot; })._id,
      &quot;itens.nome&quot;: &quot;Fone de Ouvido Bluetooth&quot;
    })._id,
    nota: 4,
    comentario: &quot;Ótimo fone, mas a bateria poderia durar mais.&quot;,
    data: new Date(&quot;2024-03-05T14:35:00Z&quot;)
  }
]);

// Avaliações para o pedido 2
db.avaliacoes.insertMany([
  {
    produto: db.produtos.findOne({ nome: &quot;Smart TV 55'&quot; })._id,
    cliente: db.clientes.findOne({ nome: &quot;Carlos Oliveira&quot; })._id,
    pedido: db.pedidos.findOne({
      cliente: db.clientes.findOne({ nome: &quot;Carlos Oliveira&quot; })._id,
      &quot;itens.nome&quot;: &quot;Smart TV 55'&quot;
    })._id,
    nota: 5,
    comentario: &quot;TV com imagem perfeita e interface muito intuitiva.&quot;,
    data: new Date(&quot;2024-03-10T09:15:00Z&quot;)
  },
  {
    produto: db.produtos.findOne({ nome: &quot;Smart TV 55'&quot; })._id,
    cliente: db.clientes.findOne({ nome: &quot;Carlos Oliveira&quot; })._id,
    pedido: db.pedidos.findOne({
      cliente: db.clientes.findOne({ nome: &quot;Carlos Oliveira&quot; })._id,
      &quot;itens.nome&quot;: &quot;Smart TV 55'&quot;
    })._id,
    nota: 5,
    comentario: &quot;Chegou antes do prazo previsto e muito bem embalada.&quot;,
    data: new Date(&quot;2024-03-10T09:20:00Z&quot;)
  }
]);

// E assim por diante para os demais pedidos...

// Continuando com avaliações para pedidos 3 a 10...
</code></pre>
<h3 id="3-busca-de-pedidos-de-cliente-especifico">3. Busca de pedidos de cliente específico</h3>
<pre><code class="language-javascript">// Buscar pedidos de Ana Silva com detalhes dos produtos
db.pedidos.aggregate([
  { $match: { cliente: db.clientes.findOne({ nome: &quot;Ana Silva&quot; })._id } },
  {
    $lookup: {
      from: &quot;produtos&quot;,
      localField: &quot;itens.produto&quot;,
      foreignField: &quot;_id&quot;,
      as: &quot;detalhes_produtos&quot;
    }
  },
  {
    $project: {
      _id: 1,
      data: 1,
      status: 1,
      valorTotal: 1,
      itens: 1,
      &quot;detalhes_produtos.nome&quot;: 1,
      &quot;detalhes_produtos.descricao&quot;: 1,
      &quot;detalhes_produtos.categoria&quot;: 1
    }
  }
])
</code></pre>
<hr />
<h2 id="tarefa-6-indices-e-otimizacao">Tarefa 6: Índices e Otimização</h2>
<h3 id="1-criacao-de-indices">1. Criação de índices</h3>
<pre><code class="language-javascript">// Índice para busca de produtos por nome
db.produtos.createIndex({ nome: 1 })

// Índice para busca de produtos por categoria e preço
db.produtos.createIndex({ categoria: 1, preco: 1 })

// Índice único para email de clientes
db.clientes.createIndex({ email: 1 }, { unique: true })

// Índice para busca de pedidos por cliente e data
db.pedidos.createIndex({ cliente: 1, data: 1 })
</code></pre>
<h3 id="2-analise-de-desempenho-com-explain">2. Análise de desempenho com explain()</h3>
<pre><code class="language-javascript">// Sem índice vs com índice
db.produtos.find({ nome: &quot;Smartphone Galaxy X20&quot; }).explain(&quot;executionStats&quot;)

// Com índice categoria-preço
db.produtos.find({
  categoria: &quot;Eletrônicos&quot;,
  preco: { $gt: 1000 }
}).explain(&quot;executionStats&quot;)
</code></pre>
<h3 id="3-criacao-de-indice-de-texto">3. Criação de índice de texto</h3>
<pre><code class="language-javascript">// Criar índice de texto para nome e descrição de produtos
db.produtos.createIndex(
  { nome: &quot;text&quot;, descricao: &quot;text&quot; },
  { weights: { nome: 2, descricao: 1 } }
)

// Testar busca por texto
db.produtos.find({ $text: { $search: &quot;smartphone android&quot; } })
</code></pre>
<hr />
<h2 id="tarefa-7-agregacoes-basicas-continuacao">Tarefa 7: Agregações Básicas (continuação)</h2>
<h3 id="5-relatorio-de-produtos-mais-vendidos">5. Relatório de produtos mais vendidos</h3>
<pre><code class="language-javascript">db.pedidos.aggregate([
  { $unwind: &quot;$itens&quot; },
  {
    $group: {
      _id: &quot;$itens.produto&quot;,
      totalVendido: { $sum: &quot;$itens.quantidade&quot; },
      valorTotal: { $sum: { $multiply: [&quot;$itens.preco&quot;, &quot;$itens.quantidade&quot;] } }
    }
  },
  {
    $lookup: {
      from: &quot;produtos&quot;,
      localField: &quot;_id&quot;,
      foreignField: &quot;_id&quot;,
      as: &quot;produto_info&quot;
    }
  },
  {
    $project: {
      _id: 0,
      produto: { $arrayElemAt: [&quot;$produto_info.nome&quot;, 0] },
      categoria: { $arrayElemAt: [&quot;$produto_info.categoria&quot;, 0] },
      totalVendido: 1,
      valorTotal: 1
    }
  },
  { $sort: { totalVendido: -1 } }
])
</code></pre>
<hr />
<h2 id="tarefa-8-agregacoes-avancadas">Tarefa 8: Agregações Avançadas</h2>
<h3 id="1-distribuicao-de-notas-nas-avaliacoes-por-categoria">1. Distribuição de notas nas avaliações por categoria</h3>
<pre><code class="language-javascript">db.avaliacoes.aggregate([
  {
    $lookup: {
      from: &quot;produtos&quot;,
      localField: &quot;produto&quot;,
      foreignField: &quot;_id&quot;,
      as: &quot;produto_info&quot;
    }
  },
  {
    $project: {
      _id: 0,
      nota: 1,
      categoria: { $arrayElemAt: [&quot;$produto_info.categoria&quot;, 0] }
    }
  },
  {
    $group: {
      _id: {
        categoria: &quot;$categoria&quot;,
        nota: &quot;$nota&quot;
      },
      quantidade: { $sum: 1 }
    }
  },
  {
    $group: {
      _id: &quot;$_id.categoria&quot;,
      distribuicao: {
        $push: {
          nota: &quot;$_id.nota&quot;,
          quantidade: &quot;$quantidade&quot;
        }
      },
      mediaNotas: { $avg: &quot;$_id.nota&quot; }
    }
  },
  {
    $project: {
      _id: 0,
      categoria: &quot;$_id&quot;,
      distribuicao: 1,
      mediaNotas: { $round: [&quot;$mediaNotas&quot;, 1] }
    }
  },
  { $sort: { categoria: 1 } }
])
</code></pre>
<h3 id="2-relatorio-de-vendas-por-dia-da-semana-e-hora-do-dia">2. Relatório de vendas por dia da semana e hora do dia</h3>
<pre><code class="language-javascript">db.pedidos.aggregate([
  {
    $project: {
      _id: 0,
      valorTotal: 1,
      diaSemana: { $dayOfWeek: &quot;$data&quot; }, // 1=domingo, 2=segunda, etc.
      hora: { $hour: &quot;$data&quot; }
    }
  },
  {
    $group: {
      _id: {
        diaSemana: &quot;$diaSemana&quot;,
        hora: &quot;$hora&quot;
      },
      totalVendas: { $sum: &quot;$valorTotal&quot; },
      quantidadePedidos: { $sum: 1 }
    }
  },
  {
    $project: {
      _id: 0,
      diaSemana: {
        $switch: {
          branches: [
            { case: { $eq: [&quot;$_id.diaSemana&quot;, 1] }, then: &quot;Domingo&quot; },
            { case: { $eq: [&quot;$_id.diaSemana&quot;, 2] }, then: &quot;Segunda-feira&quot; },
            { case: { $eq: [&quot;$_id.diaSemana&quot;, 3] }, then: &quot;Terça-feira&quot; },
            { case: { $eq: [&quot;$_id.diaSemana&quot;, 4] }, then: &quot;Quarta-feira&quot; },
            { case: { $eq: [&quot;$_id.diaSemana&quot;, 5] }, then: &quot;Quinta-feira&quot; },
            { case: { $eq: [&quot;$_id.diaSemana&quot;, 6] }, then: &quot;Sexta-feira&quot; },
            { case: { $eq: [&quot;$_id.diaSemana&quot;, 7] }, then: &quot;Sábado&quot; }
          ],
          default: &quot;Desconhecido&quot;
        }
      },
      hora: &quot;$_id.hora&quot;,
      totalVendas: 1,
      quantidadePedidos: 1
    }
  },
  { $sort: { diaSemana: 1, hora: 1 } }
])
</code></pre>
<h3 id="3-tempo-medio-entre-a-criacao-do-pedido-e-sua-entrega">3. Tempo médio entre a criação do pedido e sua entrega</h3>
<pre><code class="language-javascript">// Primeiro, vamos adicionar uma data de entrega para os pedidos entregues
// (Na prática, isso seria feito ao atualizar o status do pedido)

// Atualizar os pedidos com status &quot;Entregue&quot; para adicionar data de entrega
db.pedidos.updateMany(
  { status: &quot;Entregue&quot; },
  [
    {
      $set: {
        dataEntrega: {
          $dateAdd: {
            startDate: &quot;$data&quot;,
            unit: &quot;day&quot;,
            amount: { $floor: { $multiply: [{ $random: {} }, 5] } } // 0-4 dias após o pedido
          }
        }
      }
    }
  ]
);

// Agora calcular o tempo médio de entrega
db.pedidos.aggregate([
  { $match: { status: &quot;Entregue&quot;, dataEntrega: { $exists: true } } },
  {
    $project: {
      _id: 0,
      cliente: 1,
      tempoEntregaHoras: {
        $divide: [
          { $subtract: [&quot;$dataEntrega&quot;, &quot;$data&quot;] },
          3600000 // Converter de milissegundos para horas
        ]
      }
    }
  },
  {
    $group: {
      _id: null,
      tempoMedioHoras: { $avg: &quot;$tempoEntregaHoras&quot; },
      pedidoMaisRapido: { $min: &quot;$tempoEntregaHoras&quot; },
      pedidoMaisLento: { $max: &quot;$tempoEntregaHoras&quot; }
    }
  },
  {
    $project: {
      _id: 0,
      tempoMedioDias: { $round: [{ $divide: [&quot;$tempoMedioHoras&quot;, 24] }, 1] },
      tempoMedioHoras: { $round: [&quot;$tempoMedioHoras&quot;, 1] },
      pedidoMaisRapidoHoras: { $round: [&quot;$pedidoMaisRapido&quot;, 1] },
      pedidoMaisLentoHoras: { $round: [&quot;$pedidoMaisLento&quot;, 1] }
    }
  }
])
</code></pre>
<h3 id="4-produtos-frequentemente-comprados-juntos">4. Produtos frequentemente comprados juntos</h3>
<pre><code class="language-javascript">db.pedidos.aggregate([
  // Filtra apenas pedidos com mais de um item
  { $match: { $expr: { $gt: [{ $size: &quot;$itens&quot; }, 1] } } },
  // Desmembra os itens do pedido
  { $unwind: &quot;$itens&quot; },
  // Agrupa por produto e guarda os outros produtos no mesmo pedido
  {
    $group: {
      _id: &quot;$itens.produto&quot;,
      outrosProdutos: {
        $push: {
          $filter: {
            input: &quot;$itens&quot;,
            as: &quot;item&quot;,
            cond: { $ne: [&quot;$$item.produto&quot;, &quot;$itens.produto&quot;] }
          }
        }
      },
      nomeProduto: { $first: &quot;$itens.nome&quot; }
    }
  },
  // Desmembra os arrays de outros produtos
  { $unwind: &quot;$outrosProdutos&quot; },
  { $unwind: &quot;$outrosProdutos&quot; },
  // Agrupa para contar a frequência de cada par
  {
    $group: {
      _id: {
        produto1: &quot;$_id&quot;,
        produto2: &quot;$outrosProdutos.produto&quot;
      },
      produto1Nome: { $first: &quot;$nomeProduto&quot; },
      produto2Nome: { $first: &quot;$outrosProdutos.nome&quot; },
      frequencia: { $sum: 1 }
    }
  },
  // Filtra para eliminar duplicações (A,B e B,A)
  {
    $match: {
      $expr: {
        $gt: [&quot;$_id.produto1&quot;, &quot;$_id.produto2&quot;]
      }
    }
  },
  // Ordena por frequência
  { $sort: { frequencia: -1 } },
  // Projeta o resultado final
  {
    $project: {
      _id: 0,
      produto1: &quot;$produto1Nome&quot;,
      produto2: &quot;$produto2Nome&quot;,
      frequencia: 1
    }
  }
])
</code></pre>
<h3 id="5-dashboard-com-indicadores-de-desempenho">5. Dashboard com indicadores de desempenho</h3>
<pre><code class="language-javascript">db.pedidos.aggregate([
  // Estágio 1: Calcular vendas totais
  {
    $facet: {
      // Total de vendas geral
      &quot;vendasTotais&quot;: [
        {
          $group: {
            _id: null,
            valor: { $sum: &quot;$valorTotal&quot; },
            quantidade: { $sum: 1 }
          }
        }
      ],
      // Vendas por mês
      &quot;vendasPorMes&quot;: [
        {
          $group: {
            _id: {
              ano: { $year: &quot;$data&quot; },
              mes: { $month: &quot;$data&quot; }
            },
            valor: { $sum: &quot;$valorTotal&quot; },
            quantidade: { $sum: 1 }
          }
        },
        { $sort: { &quot;_id.ano&quot;: 1, &quot;_id.mes&quot;: 1 } }
      ],
      // Ticket médio
      &quot;ticketMedio&quot;: [
        {
          $group: {
            _id: null,
            valor: { $avg: &quot;$valorTotal&quot; }
          }
        }
      ],
      // Distribuição por status
      &quot;statusPedidos&quot;: [
        {
          $group: {
            _id: &quot;$status&quot;,
            quantidade: { $sum: 1 },
            valorTotal: { $sum: &quot;$valorTotal&quot; }
          }
        },
        { $sort: { quantidade: -1 } }
      ],
      // Produtos mais vendidos
      &quot;produtosMaisVendidos&quot;: [
        { $unwind: &quot;$itens&quot; },
        {
          $group: {
            _id: &quot;$itens.produto&quot;,
            nome: { $first: &quot;$itens.nome&quot; },
            quantidade: { $sum: &quot;$itens.quantidade&quot; },
            valorTotal: { $sum: { $multiply: [&quot;$itens.preco&quot;, &quot;$itens.quantidade&quot;] } }
          }
        },
        { $sort: { quantidade: -1 } },
        { $limit: 5 }
      ]
    }
  },
  // Estágio 2: Formatar resultados
  {
    $project: {
      metricas: {
        vendasTotais: { $arrayElemAt: [&quot;$vendasTotais.valor&quot;, 0] },
        quantidadePedidos: { $arrayElemAt: [&quot;$vendasTotais.quantidade&quot;, 0] },
        ticketMedio: { $round: [{ $arrayElemAt: [&quot;$ticketMedio.valor&quot;, 0] }, 2] }
      },
      vendasPorMes: &quot;$vendasPorMes&quot;,
      statusPedidos: &quot;$statusPedidos&quot;,
      produtosMaisVendidos: &quot;$produtosMaisVendidos&quot;
    }
  }
])
</code></pre>
<hr />
<h2 id="tarefa-9-exportacao-e-backup">Tarefa 9: Exportação e Backup</h2>
<h3 id="1-exportacao-da-colecao-de-produtos-para-csv">1. Exportação da coleção de produtos para CSV</h3>
<pre><code class="language-bash"># Usando o mongoexport
mongoexport --db ecommerce_db --collection produtos --type=csv --fields=&quot;_id,nome,descricao,preco,estoque,categoria,tags&quot; --out=produtos.csv

# Com autenticação
mongoexport --db=ecommerce_db --collection=produtos --type=csv --fields=nome,categoria,preco,estoque --out=produtos.csv --username usuario --password senha --authenticationDatabase admin
</code></pre>
<h3 id="2-script-de-backup-automatico-diario">2. Script de backup automático diário</h3>
<p><strong><code>backup_script.sh</code></strong></p>
<pre><code class="language-bash">#!/bin/bash

# Configurações
MONGO_HOST=&quot;localhost&quot;
MONGO_PORT=&quot;27017&quot;
DB_NAME=&quot;ecommerce_db&quot;
BACKUP_DIR=&quot;/backups/mongodb&quot;
DATE=$(date +&quot;%Y%m%d&quot;)
BACKUP_NAME=&quot;backup_${DB_NAME}_${DATE}&quot;

# Criar diretório de backup se não existir
mkdir -p $BACKUP_DIR

# Criar backup usando mongodump
mongodump --host $MONGO_HOST --port $MONGO_PORT --db $DB_NAME --out $BACKUP_DIR/$BACKUP_NAME

# Comprimir o backup
cd $BACKUP_DIR
tar -czf ${BACKUP_NAME}.tar.gz $BACKUP_NAME

# Remover diretório descompactado
rm -rf $BACKUP_NAME

# Manter apenas os últimos 7 backups
ls -tp $BACKUP_DIR/*.tar.gz | grep -v '/$' | tail -n +8 | xargs -I {} rm -- {}

echo &quot;Backup concluído: $BACKUP_DIR/${BACKUP_NAME}.tar.gz&quot;
</code></pre>
<p><strong>Configuração do cron para executar diariamente</strong></p>
<ul>
<li>Adicionar no crontab (<code>crontab -e</code>)</li>
</ul>
<pre><code class="language-bash">0 2 * * * /caminho/para/backup_script.sh &gt;&gt; /var/log/mongodb_backup.log 2&gt;&amp;1
</code></pre>
<h3 id="3-restauracao-de-backup-em-nova-instancia">3. Restauração de backup em nova instância</h3>
<pre><code class="language-bash"># Descomprimir o backup
tar -xzf backup_ecommerce_db_20240330.tar.gz -C /tmp/

# Restaurar usando mongorestore
mongorestore --host nova-instancia --port 27017 --db ecommerce_db_novo /tmp/backup_ecommerce_db
</code></pre>
<h3 id="4-script-para-exportar-relatorios-de-vendas-em-pdf">4. Script para exportar relatórios de vendas em PDF</h3>
<p><strong>Usando Node.js e PDFKit</strong></p>
<p>Primeiro, instalar dependências:</p>
<pre><code class="language-bash">npm install mongodb pdfkit moment fs
</code></pre>
<p><strong><code>report_generator.js</code></strong></p>
<pre><code class="language-javascript">const { MongoClient } = require('mongodb');
const PDFDocument = require('pdfkit');
const fs = require('fs');
const moment = require('moment');

// Configurações MongoDB
const uri = 'mongodb://localhost:27017';
const client = new MongoClient(uri);
const dbName = 'ecommerce_db';

async function generateSalesReport() {
  try {
    await client.connect();
    console.log('Conectado ao MongoDB');

    const db = client.db(dbName);
    const pedidosCollection = db.collection('pedidos');

    // Data do relatório
    const today = moment().format('YYYY-MM-DD');
    const fileName = `relatorio_vendas_${today}.pdf`;

    // Criar documento PDF
    const doc = new PDFDocument();
    doc.pipe(fs.createWriteStream(fileName));

    // Título e cabeçalho
    doc.fontSize(20).text('Relatório de Vendas', { align: 'center' });
    doc.fontSize(12).text(`Gerado em: ${moment().format('DD/MM/YYYY HH:mm')}`, { align: 'center' });
    doc.moveDown(2);

    // Resumo de vendas
    const resumoVendas = await pedidosCollection.aggregate([
      {
        $group: {
          _id: null,
          totalVendas: { $sum: '$valorTotal' },
          quantidadePedidos: { $sum: 1 },
          ticketMedio: { $avg: '$valorTotal' }
        }
      }
    ]).toArray();

    if (resumoVendas.length &gt; 0) {
      const resumo = resumoVendas[0];
      doc.fontSize(14).text('Resumo de Vendas');
      doc.fontSize(10);
      doc.text(`Total de Vendas: R$ ${resumo.totalVendas.toFixed(2)}`);
      doc.text(`Quantidade de Pedidos: ${resumo.quantidadePedidos}`);
      doc.text(`Ticket Médio: R$ ${resumo.ticketMedio.toFixed(2)}`);
      doc.moveDown(1);
    }

    // Vendas por mês
    doc.fontSize(14).text('Vendas por Mês');
    doc.moveDown(0.5);

    const vendasPorMes = await pedidosCollection.aggregate([
      {
        $group: {
          _id: {
            ano: { $year: '$data' },
            mes: { $month: '$data' }
          },
          totalVendas: { $sum: '$valorTotal' },
          quantidadePedidos: { $sum: 1 }
        }
      },
      { $sort: { '_id.ano': 1, '_id.mes': 1 } }
    ]).toArray();

    // Tabela de vendas por mês
    doc.fontSize(10);
    doc.text('Período', 50, doc.y, { width: 100 });
    doc.text('Total Vendas', 150, doc.y - 10, { width: 150 });
    doc.text('Quantidade', 300, doc.y - 10, { width: 100 });
    doc.moveDown(0.5);

    vendasPorMes.forEach(item =&gt; {
      const periodo = `${item._id.ano}/${item._id.mes.toString().padStart(2, '0')}`;
      doc.text(periodo, 50, doc.y, { width: 100 });
      doc.text(`R$ ${item.totalVendas.toFixed(2)}`, 150, doc.y - 10, { width: 150 });
      doc.text(`${item.quantidadePedidos}`, 300, doc.y - 10, { width: 100 });
      doc.moveDown(0.5);
    });

    doc.moveDown(1);

    // Produtos mais vendidos
    doc.fontSize(14).text('Produtos Mais Vendidos');
    doc.moveDown(0.5);

    const produtosMaisVendidos = await pedidosCollection.aggregate([
      { $unwind: '$itens' },
      {
        $group: {
          _id: '$itens.produto',
          nome: { $first: '$itens.nome' },
          quantidade: { $sum: '$itens.quantidade' },
          valorTotal: { $sum: { $multiply: ['$itens.preco', '$itens.quantidade'] } }
        }
      },
      { $sort: { quantidade: -1 } },
      { $limit: 10 }
    ]).toArray();

    // Tabela de produtos mais vendidos
    doc.fontSize(10);
    doc.text('Produto', 50, doc.y, { width: 200 });
    doc.text('Quantidade', 250, doc.y - 10, { width: 100 });
    doc.text('Valor Total', 350, doc.y - 10, { width: 100 });
    doc.moveDown(0.5);

    produtosMaisVendidos.forEach(item =&gt; {
      doc.text(item.nome, 50, doc.y, { width: 200 });
      doc.text(`${item.quantidade}`, 250, doc.y - 10, { width: 100 });
      doc.text(`R$ ${item.valorTotal.toFixed(2)}`, 350, doc.y - 10, { width: 100 });
      doc.moveDown(0.5);
    });

    // Finalizar documento
    doc.end();
    console.log(`Relatório de vendas gerado: ${fileName}`);
  } finally {
    await client.close();
  }
}

// Executar geração do relatório
generateSalesReport().catch(console.error);
</code></pre>
<h3 id="5-sistema-de-logs-para-operacoes-importantes">5. Sistema de logs para operações importantes</h3>
<p><strong>Implementação do sistema de logs usando MongoDB Change Streams</strong></p>
<p><code>logger.js</code></p>
<pre><code class="language-javascript">const { MongoClient } = require('mongodb');
const fs = require('fs');
const moment = require('moment');

// Configurações MongoDB
const uri = 'mongodb://localhost:27017';
const client = new MongoClient(uri);
const dbName = 'ecommerce_db';

async function startLogger() {
  try {
    await client.connect();
    console.log('Logger conectado ao MongoDB');

    const db = client.db(dbName);

    // Arquivo de log
    const logFile = fs.createWriteStream('mongodb_operations.log', { flags: 'a' });

    // Monitorar operações na coleção de produtos
    const produtosChangeStream = db.collection('produtos').watch();
    produtosChangeStream.on('change', (change) =&gt; {
      const timestamp = moment().format('YYYY-MM-DD HH:mm:ss');
      const operation = change.operationType;
      let details = '';

      if (operation === 'insert') {
        details = `Novo produto inserido: ${change.fullDocument.nome}`;
      } else if (operation === 'update') {
        details = `Produto atualizado: ID ${change.documentKey._id}`;
        if (change.updateDescription &amp;&amp; change.updateDescription.updatedFields) {
          details += `, Campos: ${Object.keys(change.updateDescription.updatedFields).join(', ')}`;
        }
      } else if (operation === 'delete') {
        details = `Produto removido: ID ${change.documentKey._id}`;
      }
      const logMessage = `[${timestamp}] [PRODUTOS] ${operation.toUpperCase()}: ${details}\n`;
      logFile.write(logMessage);
      console.log(logMessage);
    });

    // Monitorar operações na coleção de pedidos
    const pedidosChangeStream = db.collection('pedidos').watch();
    pedidosChangeStream.on('change', (change) =&gt; {
      const timestamp = moment().format('YYYY-MM-DD HH:mm:ss');
      const operation = change.operationType;
      let details = '';

      if (operation === 'insert') {
        details = `Novo pedido registrado: Cliente ID ${change.fullDocument.cliente}, Valor: R$ ${change.fullDocument.valorTotal}`;
      } else if (operation === 'update') {
        details = `Pedido atualizado: ID ${change.documentKey._id}`;
        if (change.updateDescription &amp;&amp; change.updateDescription.updatedFields) {
          if (change.updateDescription.updatedFields.status) {
            details += `, Novo status: ${change.updateDescription.updatedFields.status}`;
          }
        }
      } else if (operation === 'delete') {
        details = `Pedido removido: ID ${change.documentKey._id}`;
      }
      const logMessage = `[${timestamp}] [PEDIDOS] ${operation.toUpperCase()}: ${details}\n`;
      logFile.write(logMessage);
      console.log(logMessage);
    });

    console.log('Logger iniciado e monitorando operações do MongoDB');

    // Manter a conexão aberta
    process.on('SIGINT', async () =&gt; {
      console.log('Encerrando logger...');
      await client.close();
    });
  } catch (error) {
    console.error('Erro ao iniciar logger:', error);
  }
}

// Iniciar o logger
startLogger().catch(console.error);
</code></pre>
<hr />
<h2 id="tarefa-10-operacoes-com-docker">Tarefa 10: Operações com Docker</h2>
<h3 id="1-crie-um-docker-composeyml-para-mongodb-e-mongo-express">1. Crie um <code>docker-compose.yml</code> para MongoDB e Mongo Express</h3>
<pre><code class="language-yaml">version: '3'
services:
  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - &quot;27017:27017&quot;
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: senha123
    volumes:
      - mongo_data:/data/db
    networks:
      - mongo_network
  mongo-express:
    image: mongo-express:latest
    container_name: mongo-express
    depends_on:
      - mongodb
    ports:
      - &quot;8081:8081&quot;
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: senha123
      ME_CONFIG_MONGODB_SERVER: mongodb
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: senha123
    networks:
      - mongo_network
volumes:
  mongo_data:
networks:
  mongo_network:
    driver: bridge
</code></pre>
<h3 id="2-implemente-um-sistema-de-replicacao-com-3-instancias-mongodb">2. Implemente um sistema de replicação com 3 instâncias MongoDB</h3>
<pre><code class="language-bash">docker run -d --name mongo1 -p 27017:27017 mongo --replSet rs0
docker run -d --name mongo2 -p 27018:27017 mongo --replSet rs0
docker run -d --name mongo3 -p 27019:27017 mongo --replSet rs0
</code></pre>
<ul>
<li>Configurar o conjunto de réplicas</li>
</ul>
<pre><code class="language-bash">docker exec -it mongo1 mongosh --eval &quot;rs.initiate({
  _id: 'rs0',
  members: [
    { _id: 0, host: 'localhost:27017' },
    { _id: 1, host: 'localhost:27018' },
    { _id: 2, host: 'localhost:27019' }
  ]
})&quot;
</code></pre>
<hr />
<h2 id="tarefa-11-preparacao-do-projeto">Tarefa 11: Preparação do Projeto</h2>
<h3 id="1-crie-um-diagrama-de-relacionamento-entre-as-colecoes">1. Crie um diagrama de relacionamento entre as coleções</h3>
<p>(Diagrama seria inserido aqui, se fosse um formato visual)</p>
<h3 id="2-configure-indices-otimizados-para-todos-os-casos-de-uso">2. Configure índices otimizados para todos os casos de uso</h3>
<p>(Já abordado na Tarefa 6)</p>
<h3 id="3-implemente-validacao-de-esquema-para-todas-as-colecoes">3. Implemente validação de esquema para todas as coleções</h3>
<p>(Exemplo de validação de esquema para a coleção <code>produtos</code>)</p>
<pre><code class="language-javascript">db.createCollection(&quot;produtos&quot;, {
  validator: {
    $jsonSchema: {
      bsonType: &quot;object&quot;,
      required: [&quot;nome&quot;, &quot;preco&quot;, &quot;estoque&quot;, &quot;categoria&quot;],
      properties: {
        nome: {
          bsonType: &quot;string&quot;,
          description: &quot;deve ser uma string e é obrigatório&quot;
        },
        preco: {
          bsonType: &quot;double&quot;,
          minimum: 0,
          description: &quot;deve ser um double maior ou igual a 0 e é obrigatório&quot;
        },
        estoque: {
          bsonType: &quot;int&quot;,
          minimum: 0,
          description: &quot;deve ser um inteiro maior ou igual a 0 e é obrigatório&quot;
        },
        categoria: {
          bsonType: &quot;string&quot;,
          description: &quot;deve ser uma string e é obrigatório&quot;
        },
        descricao: {
          bsonType: &quot;string&quot;,
          description: &quot;deve ser uma string&quot;
        },
        tags: {
          bsonType: &quot;array&quot;,
          items: {
            bsonType: &quot;string&quot;
          },
          description: &quot;deve ser um array de strings&quot;
        }
      }
    }
  }
})
</code></pre>
<hr />
<h2 id="tarefa-12-relatorios-e-analytics">Tarefa 12: Relatórios e Analytics</h2>
<h3 id="1-desenvolva-relatorios-de-vendas-por-periodo">1. Desenvolva relatórios de vendas por período</h3>
<p>(Exemplo: Vendas diárias)</p>
<pre><code class="language-javascript">db.pedidos.aggregate([
  {
    $group: {
      _id: { $dateToString: { format: &quot;%Y-%m-%d&quot;, date: &quot;$data&quot; } },
      totalVendas: { $sum: &quot;$valorTotal&quot; },
      quantidadePedidos: { $sum: 1 }
    }
  },
  { $sort: { _id: 1 } }
])
</code></pre>
<h3 id="2-crie-um-sistema-de-recomendacao-baseado-em-compras-anteriores">2. Crie um sistema de recomendação baseado em compras anteriores</h3>
<p>(Exemplo: Produtos comprados juntos)</p>
<pre><code class="language-javascript">db.pedidos.aggregate([
  { $unwind: &quot;$itens&quot; },
  {
    $group: {
      _id: &quot;$cliente&quot;,
      produtosComprados: { $addToSet: &quot;$itens.produto&quot; }
    }
  },
  { $unwind: &quot;$produtosComprados&quot; },
  {
    $group: {
      _id: &quot;$produtosComprados&quot;,
      clientes: { $addToSet: &quot;$_id&quot; }
    }
  },
  {
    $project: {
      _id: 0,
      produtoId: &quot;$_id&quot;,
      clientesQueCompraram: &quot;$clientes&quot;,
      count: { $size: &quot;$clientes&quot; }
    }
  },
  { $sort: { count: -1 } }
])
</code></pre>
<h3 id="3-implemente-dashboards-de-metricas-para-administradores">3. Implemente dashboards de métricas para administradores</h3>
<p>(Já abordado na Tarefa 8, item 5)</p>
<h3 id="4-crie-um-sistema-de-alertas-para-produtos-com-estoque-baixo">4. Crie um sistema de alertas para produtos com estoque baixo</h3>
<pre><code class="language-javascript">db.produtos.find({
  estoque: { $lt: 10 }
})
</code></pre>
<h3 id="5-desenvolva-relatorios-de-comportamento-de-usuarios">5. Desenvolva relatórios de comportamento de usuários</h3>
<p>(Exemplo: Clientes que mais gastaram)</p>
<pre><code class="language-javascript">db.pedidos.aggregate([
  {
    $group: {
      _id: &quot;$cliente&quot;,
      totalGasto: { $sum: &quot;$valorTotal&quot; },
      totalPedidos: { $sum: 1 }
    }
  },
  {
    $lookup: {
      from: &quot;clientes&quot;,
      localField: &quot;_id&quot;,
      foreignField: &quot;_id&quot;,
      as: &quot;clienteInfo&quot;
    }
  },
  { $unwind: &quot;$clienteInfo&quot; },
  {
    $project: {
      _id: 0,
      nomeCliente: &quot;$clienteInfo.nome&quot;,
      emailCliente: &quot;$clienteInfo.email&quot;,
      totalGasto: 1,
      totalPedidos: 1
    }
  },
  { $sort: { totalGasto: -1 } },
  { $limit: 5 }
])
</code></pre>
<hr />
<h2 id="tarefa-13-entrega-e-documentacao">Tarefa 13: Entrega e Documentação</h2>
<h3 id="1-documente-todas-as-funcionalidades-implementadas">1. Documente todas as funcionalidades implementadas</h3>
<p>(Este documento serve como parte da documentação)</p>
<h3 id="2-crie-guias-de-uso-para-administradores-e-clientes">2. Crie guias de uso para administradores e clientes</h3>
<p>(Exemplo de guia para administradores: Como verificar o status do MongoDB)</p>
<pre><code class="language-bash">sudo systemctl status mongod
</code></pre></p>
    </article>
</section>
            <!-- endblock -->

            <!-- block footer -->
                <footer>
    <div class="d-flex flex-sm-row justify-content-between py-2 border-top drac-text-black drac-bg-cyan-green">
        <a href="https://github.com/dracula/mkdocs" target="_blank" style="padding-left: 1%;"
            class="footer-text drac-anchor drac-text-black drac-text-purple--hover">
            Made with Dracula Theme for MkDocs
        </a>
    </div>
</footer>
            <!-- endblock -->
        </div>

    </main>

        <script>var base_url = '../..';</script>
        <script src="../../assets/js/jquery-3.3.1.slim.min.js"></script>
        <script src="../../assets/js/bootstrap.bundle.min.js"></script>
        <script src="../../assets/js/mkdocs.js"></script>
			<script src="../../search/main.js" defer></script>

</body>

</html>